<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Predaja Pazara - Sweet Collina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Ikone
        const Icon = ({name, size=24}) => {
            const icons = {
                wallet: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
                user: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                truck: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 18H3V7h10v11M14 9h4l4 4v4h-2M7 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM17 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>,
                shield: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
                logout: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>,
                clock: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>,
                mapPin: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
                chevronRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18l6-6-6-6"/></svg>,
                arrowLeft: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>,
                check: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 6L9 17l-5-5"/></svg>,
                x: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>,
                bell: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
                creditCard: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>,
                package: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16.5 9.4L7.5 4.21M21 16V8l-9-5-9 5v8l9 5 9-5zM3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/></svg>,
                checkCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4L12 14.01l-3-3"/></svg>,
                xCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>,
                building: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18zM6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2M10 6h4M10 10h4M10 14h4M10 18h4"/></svg>,
                landmark: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 22h18M6 18V11M10 18V11M14 18V11M18 18V11M12 2l8 5H4l8-5z"/></svg>,
                users: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
                userPlus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M8.5 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM20 8v6M23 11h-6"/></svg>,
                edit: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
                trash: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>,
                save: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8"/></svg>,
                barChart: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>,
                alertCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h0"/></svg>,
                clipboard: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
                calculator: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M8 6h8M8 10h8M8 14h2M8 18h2M14 14h2M14 18h2"/></svg>,
            };
            return icons[name] || null;
        };

        // Podaci
        const LOCATIONS = [
            { id: 'MP-PAL', name: 'Palacinkarnica Collina', company: 'Sweet Collina' },
            { id: 'MP-P47', name: 'Požeška 47', company: 'Sweet Collina' },
            { id: 'MP-P96', name: 'Požeška 96', company: 'Sweet Collina' },
            { id: 'MP-NBG', name: 'Novi Beograd', company: 'Sweet Collina' },
            { id: 'MP-DRAVSKA', name: 'Dravska', company: 'Sweet Collina' },
            { id: 'PRO-PEKARA', name: 'Pro Pekara', company: 'Sweet Collina' },
            { id: 'MP-GIR', name: 'Girosito', company: 'Prima Vidra' },
        ];

        const ROLES = [
            { id: 'waiter', name: 'Konobar', icon: 'user', color: 'blue' },
            { id: 'driver', name: 'Vozač', icon: 'truck', color: 'green' },
            { id: 'admin', name: 'Administrator', icon: 'shield', color: 'purple' },
        ];

        const INITIAL_USERS = [
            { id: 1, pin: '1234', name: 'Marko Marković', role: 'waiter', locationId: 'MP-PAL' },
            { id: 2, pin: '5678', name: 'Ana Anić', role: 'waiter', locationId: 'MP-P47' },
            { id: 3, pin: '1111', name: 'Nikola Nikolić', role: 'driver', locationId: null },
            { id: 4, pin: '2222', name: 'Jelena Jelić', role: 'admin', locationId: null },
        ];

        // Specifikacije sa detaljima apoena koje je prijavio konobar
        const INITIAL_SPECS = [
            { 
                id: 1, locationId: 'MP-PAL', date: '10.01.2026.', status: 'pending', employee: 'Marko M.',
                waiterData: { // Ono što je konobar prijavio
                    counts: { 5000: 5, 2000: 4, 1000: 10, 500: 6, 200: 5, 100: 3, 50: 0, 20: 0, 10: 0 },
                    totalCash: 43300, terminal: 12500, eBar: 55800, deposit: 0
                },
                adminData: null, // Admin još nije proverio
                verifiedAmount: null,
                inSafe: 43300 // Trenutno u sefu
            },
            { 
                id: 2, locationId: 'MP-P47', date: '10.01.2026.', status: 'pending', employee: 'Ana A.',
                waiterData: {
                    counts: { 5000: 3, 2000: 5, 1000: 8, 500: 5, 200: 0, 100: 0, 50: 0, 20: 0, 10: 0 },
                    totalCash: 33500, terminal: 8200, eBar: 41700, deposit: 5000
                },
                adminData: null,
                verifiedAmount: null,
                inSafe: 33500
            },
            { 
                id: 3, locationId: 'MP-GIR', date: '10.01.2026.', status: 'pending', employee: 'Petar P.',
                waiterData: {
                    counts: { 5000: 8, 2000: 3, 1000: 5, 500: 4, 200: 5, 100: 3, 50: 0, 20: 0, 10: 0 },
                    totalCash: 52300, terminal: 15000, eBar: 67300, deposit: 0
                },
                adminData: null,
                verifiedAmount: null,
                inSafe: 52300
            },
            { 
                id: 4, locationId: 'MP-NBG', date: '09.01.2026.', status: 'verified', employee: 'Ivan I.',
                waiterData: {
                    counts: { 5000: 6, 2000: 5, 1000: 8, 500: 2, 200: 5, 100: 0, 50: 0, 20: 0, 10: 0 },
                    totalCash: 50000, terminal: 10000, eBar: 60000, deposit: 0
                },
                adminData: {
                    counts: { 5000: 6, 2000: 5, 1000: 8, 500: 2, 200: 5, 100: 0, 50: 0, 20: 0, 10: 0 },
                    totalCash: 50000, note: ''
                },
                verifiedAmount: 50000,
                inSafe: 50000
            },
            { 
                id: 5, locationId: 'MP-P96', date: '08.01.2026.', status: 'deposited', employee: 'Jovana J.',
                waiterData: {
                    counts: { 5000: 4, 2000: 3, 1000: 5, 500: 2, 200: 0, 100: 0, 50: 0, 20: 0, 10: 0 },
                    totalCash: 32000, terminal: 5000, eBar: 37000, deposit: 0
                },
                adminData: {
                    counts: { 5000: 4, 2000: 3, 1000: 5, 500: 2, 200: 0, 100: 0, 50: 0, 20: 0, 10: 0 },
                    totalCash: 32000, note: ''
                },
                verifiedAmount: 32000,
                inSafe: 0,
                depositedAmount: 32000,
                depositDate: '09.01.2026.',
                depositNote: ''
            },
        ];

        const DENOMINATIONS = [
            { value: 5000, label: '5.000' }, { value: 2000, label: '2.000' }, { value: 1000, label: '1.000' },
            { value: 500, label: '500' }, { value: 200, label: '200' }, { value: 100, label: '100' },
            { value: 50, label: '50' }, { value: 20, label: '20' }, { value: 10, label: '10' },
        ];

        const formatCurrency = (n) => new Intl.NumberFormat('sr-RS').format(n) + ' RSD';

        // ==================== KOMPONENTE ====================

        const Notification = ({ message, type, onClose }) => (
            <div className={`fixed top-4 right-4 left-4 z-50 p-4 rounded-lg border-2 shadow-lg flex items-center gap-3 ${type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : type === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-blue-50 border-blue-200 text-blue-800'}`}>
                <Icon name="bell" /><span className="font-medium flex-1">{message}</span><button onClick={onClose}><Icon name="x" /></button>
            </div>
        );

        const Header = ({ user, onLogout, title, onBack }) => {
            const loc = LOCATIONS.find(l => l.id === user.locationId);
            return (
                <div className="bg-white border-b sticky top-0 z-40">
                    <div className="max-w-lg mx-auto px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            {onBack && <button onClick={onBack} className="p-2 -ml-2 text-gray-400"><Icon name="arrowLeft" /></button>}
                            <div><h1 className="font-bold text-gray-800">{title}</h1><p className="text-sm text-gray-500">{user.name}{loc && ` • ${loc.name}`}</p></div>
                        </div>
                        <button onClick={onLogout} className="p-2 text-gray-400 hover:text-red-500 rounded-lg"><Icon name="logout" /></button>
                    </div>
                </div>
            );
        };

        // ==================== LOGIN ====================
        const LoginScreen = ({ onLogin, users }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); const u = users.find(x => x.pin === pin); if (u) onLogin(u); else { setError('Pogrešna šifra'); setPin(''); } };
            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600"><Icon name="wallet" /></div>
                            <h1 className="text-2xl font-bold text-gray-800">Predaja Pazara</h1>
                            <p className="text-gray-500 mt-1">Unesite vašu šifru</p>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="flex justify-center gap-3 mb-6">
                                {[0,1,2,3].map(i => <div key={i} className={`w-14 h-14 rounded-xl border-2 flex items-center justify-center text-2xl font-bold ${pin.length > i ? 'border-indigo-500 bg-indigo-50 text-indigo-600' : 'border-gray-200'}`}>{pin.length > i ? '•' : ''}</div>)}
                            </div>
                            {error && <div className="text-red-500 text-center mb-4 flex items-center justify-center gap-2"><Icon name="alertCircle" />{error}</div>}
                            <div className="grid grid-cols-3 gap-3 mb-6">
                                {[1,2,3,4,5,6,7,8,9,null,0,'del'].map((n,i) => <button key={i} type="button" onClick={() => n === 'del' ? setPin(p => p.slice(0,-1)) : n !== null && pin.length < 4 && setPin(p => p + n)} disabled={n === null} className={`h-14 rounded-xl text-xl font-semibold ${n === null ? 'invisible' : n === 'del' ? 'bg-gray-100 text-gray-600' : 'bg-gray-50 text-gray-800 hover:bg-indigo-50 active:scale-95'}`}>{n === 'del' ? '⌫' : n}</button>)}
                            </div>
                            <button type="submit" disabled={pin.length !== 4} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-semibold text-lg disabled:bg-gray-300">Prijava</button>
                        </form>
                        <p className="text-center text-gray-400 text-sm mt-6">Sweet Collina DOO / Prima Vidra</p>
                    </div>
                </div>
            );
        };

        // ==================== KONOBAR HOME ====================
        const WaiterHome = ({ user, currentShift, onStartShift, onEndShift }) => {
            const loc = LOCATIONS.find(l => l.id === user.locationId);
            return (
                <div className="p-4 space-y-4">
                    <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white">
                        <div className="flex items-center gap-3 mb-4"><Icon name="mapPin" /><span className="opacity-80">{loc?.name}</span></div>
                        <h2 className="text-3xl font-bold mb-1">{currentShift ? 'Smena aktivna' : 'Nema aktivne smene'}</h2>
                        <p className="opacity-80">{currentShift ? `Započeto: ${currentShift.startTime}` : 'Započnite smenu'}</p>
                    </div>
                    {!currentShift ? (
                        <button onClick={onStartShift} className="w-full bg-green-500 text-white rounded-2xl p-6 flex items-center justify-between">
                            <div className="flex items-center gap-4"><div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center"><Icon name="clock" /></div><div className="text-left"><p className="font-bold text-lg">Započni smenu</p><p className="opacity-80 text-sm">Prijava na početku rada</p></div></div><Icon name="chevronRight" />
                        </button>
                    ) : (
                        <button onClick={onEndShift} className="w-full bg-orange-500 text-white rounded-2xl p-6 flex items-center justify-between">
                            <div className="flex items-center gap-4"><div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center"><Icon name="logout" /></div><div className="text-left"><p className="font-bold text-lg">Završi smenu</p><p className="opacity-80 text-sm">Predaja pazara</p></div></div><Icon name="chevronRight" />
                        </button>
                    )}
                </div>
            );
        };

        // ==================== VOZAČ HOME (bez iznosa) ====================
        const DriverHome = ({ pickups, setPickups, onHandover }) => {
            const pendingCount = pickups.filter(p => p.status === 'pending').length;
            const pickedCount = pickups.filter(p => p.status === 'picked').length;
            const allPicked = pickups.every(p => p.status === 'picked');

            return (
                <div className="p-4 space-y-4">
                    <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 text-white">
                        <div className="flex items-center gap-3 mb-2"><Icon name="truck" /><span className="opacity-80">Preuzimanje pazara</span></div>
                        <p className="text-3xl font-bold">{pickedCount} / {pickups.length}</p>
                        <p className="opacity-80 mt-1">lokacija preuzeto</p>
                    </div>

                    <h2 className="font-bold text-gray-800">Lokacije za danas</h2>
                    
                    {pickups.map(p => {
                        const loc = LOCATIONS.find(l => l.id === p.locationId);
                        return (
                            <div key={p.id} className={`rounded-xl p-4 border-2 ${p.status === 'picked' ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`}>
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${p.status === 'picked' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-400'}`}>
                                            {p.status === 'picked' ? <Icon name="check" size={20} /> : <Icon name="package" size={20} />}
                                        </div>
                                        <div>
                                            <p className="font-semibold text-gray-800">{loc?.name}</p>
                                            <p className="text-sm text-gray-500">{loc?.company}</p>
                                        </div>
                                    </div>
                                    {p.status === 'picked' ? (
                                        <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">Preuzeto</span>
                                    ) : (
                                        <button 
                                            onClick={() => setPickups(pickups.map(x => x.id === p.id ? {...x, status: 'picked', pickedAt: new Date().toLocaleTimeString('sr-RS', {hour:'2-digit', minute:'2-digit'})} : x))} 
                                            className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold"
                                        >
                                            Preuzmi
                                        </button>
                                    )}
                                </div>
                                {p.status === 'picked' && p.pickedAt && (
                                    <p className="text-sm text-green-600 mt-2 ml-13">Preuzeto u {p.pickedAt}</p>
                                )}
                            </div>
                        );
                    })}

                    {allPicked && pickups.length > 0 && (
                        <button onClick={onHandover} className="w-full bg-green-500 text-white rounded-2xl p-6 flex items-center justify-between mt-4">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center"><Icon name="building" /></div>
                                <div className="text-left">
                                    <p className="font-bold text-lg">Predaj administratoru</p>
                                    <p className="opacity-80 text-sm">Sve lokacije preuzete</p>
                                </div>
                            </div>
                            <Icon name="chevronRight" />
                        </button>
                    )}
                </div>
            );
        };

        // ==================== ADMIN - PROVERA SPECIFIKACIJE ====================
        const VerifySpecification = ({ spec, onVerify, onCancel }) => {
            const [adminCounts, setAdminCounts] = useState(
                spec.waiterData?.counts || {}
            );
            const [note, setNote] = useState('');
            const loc = LOCATIONS.find(l => l.id === spec.locationId);

            const waiterTotal = spec.waiterData?.totalCash || 0;
            const adminTotal = DENOMINATIONS.reduce((sum, d) => sum + (d.value * (adminCounts[d.value] || 0)), 0);
            const difference = adminTotal - waiterTotal;

            const handleVerify = () => {
                onVerify(spec.id, {
                    counts: adminCounts,
                    totalCash: adminTotal,
                    note: note
                }, adminTotal);
            };

            return (
                <div className="p-4 space-y-4">
                    <div className="bg-indigo-50 rounded-xl p-4">
                        <p className="font-bold text-indigo-800">{loc?.name}</p>
                        <p className="text-sm text-indigo-600">{spec.date} • {spec.employee}</p>
                    </div>

                    {/* Konobar prijavio */}
                    <div className="bg-gray-50 rounded-xl p-4">
                        <p className="font-semibold text-gray-700 mb-2">Konobar prijavio:</p>
                        <div className="grid grid-cols-2 gap-2 text-sm">
                            <div>E-Bar: <span className="font-semibold">{formatCurrency(spec.waiterData?.eBar || 0)}</span></div>
                            <div>Terminal: <span className="font-semibold">{formatCurrency(spec.waiterData?.terminal || 0)}</span></div>
                            <div>Depozit: <span className="font-semibold">{formatCurrency(spec.waiterData?.deposit || 0)}</span></div>
                            <div>Gotovina: <span className="font-bold text-indigo-600">{formatCurrency(waiterTotal)}</span></div>
                        </div>
                    </div>

                    {/* Admin unos apoena */}
                    <div>
                        <p className="font-semibold text-gray-700 mb-3">Vaše brojanje (unesite broj novčanica):</p>
                        <div className="space-y-2">
                            {DENOMINATIONS.map(d => (
                                <div key={d.value} className="flex items-center gap-2 bg-white rounded-lg p-2 border">
                                    <span className="w-16 font-semibold text-gray-700">{d.label}</span>
                                    <span className="text-gray-400">×</span>
                                    <input
                                        type="number"
                                        min="0"
                                        value={adminCounts[d.value] || ''}
                                        onChange={(e) => setAdminCounts({...adminCounts, [d.value]: parseInt(e.target.value) || 0})}
                                        placeholder="0"
                                        className="flex-1 p-2 text-center font-semibold border rounded focus:border-indigo-500 focus:outline-none"
                                    />
                                    <span className="w-24 text-right text-sm text-gray-600">{formatCurrency(d.value * (adminCounts[d.value] || 0))}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Poređenje */}
                    <div className={`rounded-xl p-4 ${difference === 0 ? 'bg-green-50 border-2 border-green-200' : difference > 0 ? 'bg-blue-50 border-2 border-blue-200' : 'bg-red-50 border-2 border-red-200'}`}>
                        <div className="flex justify-between mb-2">
                            <span>Konobar prijavio:</span>
                            <span className="font-semibold">{formatCurrency(waiterTotal)}</span>
                        </div>
                        <div className="flex justify-between mb-2">
                            <span>Vi izbrojali:</span>
                            <span className="font-bold text-lg">{formatCurrency(adminTotal)}</span>
                        </div>
                        <div className="flex justify-between pt-2 border-t">
                            <span className="font-semibold">Razlika:</span>
                            <span className={`font-bold text-lg ${difference === 0 ? 'text-green-600' : difference > 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                {difference > 0 ? '+' : ''}{formatCurrency(difference)}
                                {difference === 0 && ' ✓'}
                            </span>
                        </div>
                    </div>

                    {/* Napomena */}
                    {difference !== 0 && (
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Napomena (obavezno ako ima razlike):</label>
                            <textarea
                                value={note}
                                onChange={(e) => setNote(e.target.value)}
                                placeholder="Unesite objašnjenje za razliku..."
                                className="w-full p-3 border-2 rounded-xl focus:border-indigo-500 focus:outline-none"
                                rows={3}
                            />
                        </div>
                    )}

                    {/* Dugmad */}
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-4 border-2 border-gray-200 text-gray-600 rounded-xl font-semibold">Otkaži</button>
                        <button 
                            onClick={handleVerify}
                            disabled={difference !== 0 && !note.trim()}
                            className="flex-1 py-4 bg-green-500 text-white rounded-xl font-semibold disabled:bg-gray-300"
                        >
                            ✓ Potvrdi
                        </button>
                    </div>
                </div>
            );
        };

        // ==================== ADMIN - UPLATA ====================
        const DepositFlow = ({ specs, onDeposit, onCancel }) => {
            const [selected, setSelected] = useState([]);
            const [step, setStep] = useState('select'); // select, amount, confirm
            const [depositAmounts, setDepositAmounts] = useState({});
            const [partialReason, setPartialReason] = useState('');

            const verifiedSpecs = specs.filter(s => s.status === 'verified');
            const totalSelected = selected.reduce((sum, id) => {
                const sp = verifiedSpecs.find(s => s.id === id);
                return sum + (sp?.inSafe || 0);
            }, 0);

            const totalToDeposit = selected.reduce((sum, id) => sum + (depositAmounts[id] || 0), 0);
            const hasPartial = selected.some(id => {
                const sp = verifiedSpecs.find(s => s.id === id);
                return (depositAmounts[id] || 0) < (sp?.inSafe || 0);
            });

            const handleNext = () => {
                if (step === 'select') {
                    // Inicijalizuj iznose na pun iznos
                    const amounts = {};
                    selected.forEach(id => {
                        const sp = verifiedSpecs.find(s => s.id === id);
                        amounts[id] = sp?.inSafe || 0;
                    });
                    setDepositAmounts(amounts);
                    setStep('amount');
                } else if (step === 'amount') {
                    setStep('confirm');
                }
            };

            const handleDeposit = () => {
                onDeposit(selected, depositAmounts, partialReason);
            };

            if (step === 'select') {
                return (
                    <div className="p-4 space-y-4">
                        <h2 className="text-xl font-bold text-gray-800">Izaberi za uplatu</h2>
                        
                        {verifiedSpecs.length === 0 ? (
                            <p className="text-center py-8 text-gray-500">Nema pazara za uplatu</p>
                        ) : (
                            <>
                                {verifiedSpecs.map(sp => {
                                    const loc = LOCATIONS.find(l => l.id === sp.locationId);
                                    const isSel = selected.includes(sp.id);
                                    return (
                                        <button 
                                            key={sp.id} 
                                            onClick={() => setSelected(isSel ? selected.filter(i => i !== sp.id) : [...selected, sp.id])} 
                                            className={`w-full rounded-xl p-4 border-2 text-left ${isSel ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 bg-white'}`}
                                        >
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSel ? 'border-indigo-500 bg-indigo-500 text-white' : 'border-gray-300'}`}>
                                                        {isSel && <Icon name="check" size={16} />}
                                                    </div>
                                                    <div>
                                                        <p className="font-semibold text-gray-800">{loc?.name}</p>
                                                        <p className="text-sm text-gray-500">{sp.date} • {sp.employee}</p>
                                                    </div>
                                                </div>
                                                <p className="font-bold">{formatCurrency(sp.inSafe)}</p>
                                            </div>
                                        </button>
                                    );
                                })}

                                {selected.length > 0 && (
                                    <div className="bg-indigo-50 rounded-xl p-4">
                                        <div className="flex justify-between items-center">
                                            <span className="font-semibold text-indigo-800">Izabrano ({selected.length}):</span>
                                            <span className="font-bold text-xl text-indigo-600">{formatCurrency(totalSelected)}</span>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-4 border-2 border-gray-200 text-gray-600 rounded-xl font-semibold">Otkaži</button>
                            <button 
                                onClick={handleNext}
                                disabled={selected.length === 0}
                                className="flex-1 py-4 bg-indigo-600 text-white rounded-xl font-semibold disabled:bg-gray-300"
                            >
                                Nastavi
                            </button>
                        </div>
                    </div>
                );
            }

            if (step === 'amount') {
                return (
                    <div className="p-4 space-y-4">
                        <h2 className="text-xl font-bold text-gray-800">Unesi iznose za uplatu</h2>
                        <p className="text-gray-500 text-sm">Možete uplatiti ceo iznos ili deo (ostatak ostaje u sefu)</p>

                        {selected.map(id => {
                            const sp = verifiedSpecs.find(s => s.id === id);
                            const loc = LOCATIONS.find(l => l.id === sp?.locationId);
                            const isPartial = (depositAmounts[id] || 0) < (sp?.inSafe || 0);
                            return (
                                <div key={id} className="bg-white rounded-xl p-4 border-2 border-gray-200">
                                    <div className="flex justify-between items-center mb-3">
                                        <div>
                                            <p className="font-semibold text-gray-800">{loc?.name}</p>
                                            <p className="text-sm text-gray-500">U sefu: {formatCurrency(sp?.inSafe || 0)}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-500">Uplata:</span>
                                        <input
                                            type="number"
                                            value={depositAmounts[id] || ''}
                                            onChange={(e) => setDepositAmounts({...depositAmounts, [id]: parseInt(e.target.value) || 0})}
                                            max={sp?.inSafe || 0}
                                            className="flex-1 p-3 text-lg font-bold text-center border-2 rounded-xl focus:border-indigo-500 focus:outline-none"
                                        />
                                        <span className="text-gray-500">RSD</span>
                                    </div>
                                    {isPartial && (
                                        <p className="text-orange-600 text-sm mt-2">
                                            Ostaje u sefu: {formatCurrency((sp?.inSafe || 0) - (depositAmounts[id] || 0))}
                                        </p>
                                    )}
                                </div>
                            );
                        })}

                        {hasPartial && (
                            <div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
                                <p className="font-semibold text-orange-800 mb-2">Razlog delimične uplate:</p>
                                <textarea
                                    value={partialReason}
                                    onChange={(e) => setPartialReason(e.target.value)}
                                    placeholder="Navedite zašto ne uplaćujete ceo iznos..."
                                    className="w-full p-3 border-2 rounded-xl focus:border-orange-500 focus:outline-none"
                                    rows={3}
                                />
                            </div>
                        )}

                        <div className="bg-green-50 rounded-xl p-4">
                            <div className="flex justify-between items-center">
                                <span className="font-semibold text-green-800">Za uplatu:</span>
                                <span className="font-bold text-xl text-green-600">{formatCurrency(totalToDeposit)}</span>
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={() => setStep('select')} className="flex-1 py-4 border-2 border-gray-200 text-gray-600 rounded-xl font-semibold">Nazad</button>
                            <button 
                                onClick={handleNext}
                                disabled={totalToDeposit === 0 || (hasPartial && !partialReason.trim())}
                                className="flex-1 py-4 bg-indigo-600 text-white rounded-xl font-semibold disabled:bg-gray-300"
                            >
                                Nastavi
                            </button>
                        </div>
                    </div>
                );
            }

            if (step === 'confirm') {
                return (
                    <div className="p-4 space-y-4">
                        <h2 className="text-xl font-bold text-gray-800">Potvrda uplate</h2>

                        <div className="space-y-3">
                            {selected.map(id => {
                                const sp = verifiedSpecs.find(s => s.id === id);
                                const loc = LOCATIONS.find(l => l.id === sp?.locationId);
                                const remaining = (sp?.inSafe || 0) - (depositAmounts[id] || 0);
                                return (
                                    <div key={id} className="bg-gray-50 rounded-xl p-4">
                                        <div className="flex justify-between items-center">
                                            <p className="font-semibold">{loc?.name}</p>
                                            <p className="font-bold text-green-600">{formatCurrency(depositAmounts[id] || 0)}</p>
                                        </div>
                                        {remaining > 0 && (
                                            <p className="text-sm text-orange-600 mt-1">Ostaje u sefu: {formatCurrency(remaining)}</p>
                                        )}
                                    </div>
                                );
                            })}
                        </div>

                        {partialReason && (
                            <div className="bg-orange-50 rounded-xl p-4">
                                <p className="text-sm text-orange-700"><strong>Razlog:</strong> {partialReason}</p>
                            </div>
                        )}

                        <div className="bg-green-100 rounded-xl p-6 text-center">
                            <p className="text-green-700 mb-2">UKUPNO ZA UPLATU</p>
                            <p className="text-4xl font-bold text-green-700">{formatCurrency(totalToDeposit)}</p>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={() => setStep('amount')} className="flex-1 py-4 border-2 border-gray-200 text-gray-600 rounded-xl font-semibold">Nazad</button>
                            <button 
                                onClick={handleDeposit}
                                className="flex-1 py-4 bg-green-500 text-white rounded-xl font-semibold flex items-center justify-center gap-2"
                            >
                                <Icon name="landmark" size={20} /> Potvrdi uplatu
                            </button>
                        </div>
                    </div>
                );
            }
        };

        // ==================== ADMIN HOME ====================
        const AdminHome = ({ onManageUsers, onReports, specs, setSpecs }) => {
            const [tab, setTab] = useState('pending');
            const [verifyingSpec, setVerifyingSpec] = useState(null);
            const [depositMode, setDepositMode] = useState(false);

            const pending = specs.filter(s => s.status === 'pending');
            const verified = specs.filter(s => s.status === 'verified');
            const deposited = specs.filter(s => s.status === 'deposited');

            const handleVerify = (specId, adminData, verifiedAmount) => {
                setSpecs(specs.map(s => s.id === specId ? {
                    ...s, 
                    status: 'verified', 
                    adminData: adminData,
                    verifiedAmount: verifiedAmount,
                    inSafe: verifiedAmount
                } : s));
                setVerifyingSpec(null);
            };

            const handleDeposit = (selectedIds, amounts, reason) => {
                const today = new Date().toLocaleDateString('sr-RS');
                setSpecs(specs.map(s => {
                    if (selectedIds.includes(s.id)) {
                        const depositedAmt = amounts[s.id] || 0;
                        const remaining = (s.inSafe || 0) - depositedAmt;
                        
                        if (remaining <= 0) {
                            // Ceo iznos uplaćen
                            return {
                                ...s,
                                status: 'deposited',
                                depositedAmount: depositedAmt,
                                depositDate: today,
                                depositNote: reason || '',
                                inSafe: 0
                            };
                        } else {
                            // Delimična uplata - ostaje verified sa smanjenim iznosom u sefu
                            return {
                                ...s,
                                depositedAmount: (s.depositedAmount || 0) + depositedAmt,
                                partialDepositDate: today,
                                partialDepositNote: reason,
                                inSafe: remaining
                            };
                        }
                    }
                    return s;
                }));
                setDepositMode(false);
            };

            if (verifyingSpec) {
                return (
                    <div className="max-w-lg mx-auto">
                        <VerifySpecification 
                            spec={verifyingSpec} 
                            onVerify={handleVerify}
                            onCancel={() => setVerifyingSpec(null)}
                        />
                    </div>
                );
            }

            if (depositMode) {
                return (
                    <div className="max-w-lg mx-auto">
                        <DepositFlow 
                            specs={specs}
                            onDeposit={handleDeposit}
                            onCancel={() => setDepositMode(false)}
                        />
                    </div>
                );
            }

            const totalInSafe = [...pending, ...verified].reduce((sum, s) => sum + (s.inSafe || 0), 0);

            return (
                <div className="p-4 space-y-4">
                    {/* Brzi pristup */}
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={onManageUsers} className="bg-gradient-to-br from-purple-500 to-indigo-600 text-white rounded-2xl p-4 flex flex-col items-start">
                            <Icon name="users" /><span className="font-semibold mt-2">Korisnici</span>
                        </button>
                        <button onClick={onReports} className="bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-2xl p-4 flex flex-col items-start">
                            <Icon name="barChart" /><span className="font-semibold mt-2">Izveštaji</span>
                        </button>
                    </div>

                    {/* Ukupno u sefu */}
                    <div className="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 text-white">
                        <div className="flex justify-between items-center">
                            <div>
                                <p className="opacity-80 text-sm">Ukupno u sefu</p>
                                <p className="text-2xl font-bold">{formatCurrency(totalInSafe)}</p>
                            </div>
                            <button 
                                onClick={() => setDepositMode(true)}
                                disabled={verified.length === 0}
                                className="px-4 py-2 bg-white/20 rounded-xl font-semibold text-sm disabled:opacity-50"
                            >
                                Uplati u banku
                            </button>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="grid grid-cols-3 gap-2">
                        <button onClick={() => setTab('pending')} className={`rounded-xl p-3 ${tab === 'pending' ? 'bg-orange-100 border-2 border-orange-300' : 'bg-gray-50'}`}>
                            <p className="text-2xl font-bold text-orange-600">{pending.length}</p>
                            <p className="text-xs text-gray-600">Za proveru</p>
                        </button>
                        <button onClick={() => setTab('verified')} className={`rounded-xl p-3 ${tab === 'verified' ? 'bg-blue-100 border-2 border-blue-300' : 'bg-gray-50'}`}>
                            <p className="text-2xl font-bold text-blue-600">{verified.length}</p>
                            <p className="text-xs text-gray-600">U sefu</p>
                        </button>
                        <button onClick={() => setTab('deposited')} className={`rounded-xl p-3 ${tab === 'deposited' ? 'bg-green-100 border-2 border-green-300' : 'bg-gray-50'}`}>
                            <p className="text-2xl font-bold text-green-600">{deposited.length}</p>
                            <p className="text-xs text-gray-600">Uplaćeno</p>
                        </button>
                    </div>

                    {/* Lista */}
                    {tab === 'pending' && (
                        <div className="space-y-3">
                            <h2 className="font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="clipboard" size={20} /> Čeka proveru
                            </h2>
                            {pending.length === 0 ? (
                                <p className="text-center py-8 text-gray-500">Nema specifikacija za proveru</p>
                            ) : pending.map(sp => {
                                const loc = LOCATIONS.find(l => l.id === sp.locationId);
                                return (
                                    <div key={sp.id} className="bg-white rounded-xl p-4 border-2 border-orange-200">
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <p className="font-semibold text-gray-800">{loc?.name}</p>
                                                <p className="text-sm text-gray-500">{sp.date} • {sp.employee}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-bold text-lg">{formatCurrency(sp.waiterData?.totalCash || 0)}</p>
                                                <p className="text-xs text-gray-500">prijavljeno</p>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => setVerifyingSpec(sp)}
                                            className="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold flex items-center justify-center gap-2"
                                        >
                                            <Icon name="calculator" size={20} /> Proveri i potvrdi
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {tab === 'verified' && (
                        <div className="space-y-3">
                            <h2 className="font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="package" size={20} /> U sefu
                            </h2>
                            {verified.length === 0 ? (
                                <p className="text-center py-8 text-gray-500">Sef je prazan</p>
                            ) : verified.map(sp => {
                                const loc = LOCATIONS.find(l => l.id === sp.locationId);
                                return (
                                    <div key={sp.id} className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <p className="font-semibold text-gray-800">{loc?.name}</p>
                                                <p className="text-sm text-gray-500">{sp.date} • {sp.employee}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-bold text-lg text-blue-700">{formatCurrency(sp.inSafe || 0)}</p>
                                                {sp.depositedAmount > 0 && (
                                                    <p className="text-xs text-green-600">Već uplaćeno: {formatCurrency(sp.depositedAmount)}</p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {tab === 'deposited' && (
                        <div className="space-y-3">
                            <h2 className="font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="landmark" size={20} /> Uplaćeno
                            </h2>
                            {deposited.length === 0 ? (
                                <p className="text-center py-8 text-gray-500">Nema uplata</p>
                            ) : deposited.map(sp => {
                                const loc = LOCATIONS.find(l => l.id === sp.locationId);
                                return (
                                    <div key={sp.id} className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <p className="font-semibold text-gray-800">{loc?.name}</p>
                                                <p className="text-sm text-gray-500">{sp.date} • {sp.employee}</p>
                                                <p className="text-sm text-green-600">Uplaćeno: {sp.depositDate}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-bold text-lg text-green-700">{formatCurrency(sp.depositedAmount || 0)}</p>
                                                <span className="text-green-600 text-sm">✓</span>
                                            </div>
                                        </div>
                                        {sp.depositNote && (
                                            <p className="text-sm text-gray-600 mt-2 pt-2 border-t">Napomena: {sp.depositNote}</p>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // ==================== IZVEŠTAJI ====================
        const Reports = ({ specs }) => {
            const [tab, setTab] = useState('safe');
            const pending = specs.filter(s => s.status === 'pending');
            const verified = specs.filter(s => s.status === 'verified');
            const deposited = specs.filter(s => s.status === 'deposited');
            const inSafe = [...pending, ...verified];
            const totalSafe = inSafe.reduce((s,x) => s + (x.inSafe || 0), 0);
            const totalDeposited = deposited.reduce((s,x) => s + (x.depositedAmount || 0), 0);

            const byLocation = LOCATIONS.map(loc => {
                const locSpecs = inSafe.filter(s => s.locationId === loc.id);
                return { ...loc, total: locSpecs.reduce((s,x) => s + (x.inSafe || 0), 0), count: locSpecs.length, specs: locSpecs };
            }).filter(l => l.total > 0);

            return (
                <div className="p-4 space-y-4">
                    <div className="flex gap-2 bg-gray-100 p-1 rounded-xl">
                        {[['safe','U sefu'],['deposits','Uplate'],['summary','Sumarno']].map(([k,v]) => (
                            <button key={k} onClick={() => setTab(k)} className={`flex-1 py-2 px-3 rounded-lg text-sm font-semibold ${tab === k ? 'bg-white shadow text-indigo-600' : 'text-gray-600'}`}>{v}</button>
                        ))}
                    </div>

                    {tab === 'safe' && (
                        <div className="space-y-4">
                            <div className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-6 text-white">
                                <div className="flex items-center gap-3 mb-2"><Icon name="package" /><span className="opacity-80">Ukupno u sefu</span></div>
                                <p className="text-4xl font-bold">{formatCurrency(totalSafe)}</p>
                            </div>
                            <h3 className="font-bold text-gray-800">Po lokacijama</h3>
                            {byLocation.length === 0 ? <p className="text-center py-8 text-gray-500">Nema novca u sefu</p> : byLocation.map(loc => (
                                <div key={loc.id} className="bg-white rounded-xl p-4 border-2 border-gray-100">
                                    <div className="flex justify-between items-start mb-2">
                                        <div><p className="font-semibold text-gray-800">{loc.name}</p><p className="text-sm text-gray-500">{loc.count} spec.</p></div>
                                        <p className="text-xl font-bold text-indigo-600">{formatCurrency(loc.total)}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {tab === 'deposits' && (
                        <div className="space-y-4">
                            <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 text-white">
                                <div className="flex items-center gap-3 mb-2"><Icon name="landmark" /><span className="opacity-80">Ukupno uplaćeno</span></div>
                                <p className="text-4xl font-bold">{formatCurrency(totalDeposited)}</p>
                            </div>
                            <h3 className="font-bold text-gray-800">Istorija uplata</h3>
                            {deposited.length === 0 ? <p className="text-center py-8 text-gray-500">Nema uplata</p> : deposited.map(sp => {
                                const loc = LOCATIONS.find(l => l.id === sp.locationId);
                                return (
                                    <div key={sp.id} className="bg-green-50 rounded-xl p-4 border-2 border-green-100">
                                        <div className="flex justify-between items-start">
                                            <div><p className="font-semibold text-gray-800">{loc?.name}</p><p className="text-sm text-gray-500">{sp.date}</p><p className="text-sm text-green-600">Uplaćeno: {sp.depositDate}</p></div>
                                            <p className="text-xl font-bold text-green-700">{formatCurrency(sp.depositedAmount || 0)}</p>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {tab === 'summary' && (
                        <div className="space-y-4">
                            <div className="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-6 text-white">
                                <div className="flex items-center gap-3 mb-2"><Icon name="barChart" /><span className="opacity-80">Ukupan pregled</span></div>
                                <p className="text-4xl font-bold">{formatCurrency(totalSafe + totalDeposited)}</p>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-100"><p className="text-orange-600 text-sm">Čeka proveru</p><p className="text-2xl font-bold text-orange-700">{pending.length}</p></div>
                                <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-100"><p className="text-blue-600 text-sm">U sefu</p><p className="text-2xl font-bold text-blue-700">{verified.length}</p></div>
                                <div className="bg-green-50 rounded-xl p-4 border-2 border-green-100"><p className="text-green-600 text-sm">Uplaćeno</p><p className="text-2xl font-bold text-green-700">{deposited.length}</p></div>
                                <div className="bg-indigo-50 rounded-xl p-4 border-2 border-indigo-100"><p className="text-indigo-600 text-sm">U sefu (RSD)</p><p className="text-lg font-bold text-indigo-700">{formatCurrency(totalSafe)}</p></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==================== USER MANAGEMENT ====================
        const UserManagement = ({ users, onAdd, onUpdate, onDelete }) => {
            const [view, setView] = useState('list');
            const [editing, setEditing] = useState(null);
            const [form, setForm] = useState({ name: '', pin: '', role: 'waiter', locationId: '' });
            const [delConfirm, setDelConfirm] = useState(null);

            const handleSave = () => {
                if (!form.name || form.pin.length !== 4) return;
                if (editing) onUpdate(editing.id, form); else onAdd(form);
                setView('list'); setForm({ name: '', pin: '', role: 'waiter', locationId: '' }); setEditing(null);
            };

            if (view === 'form') {
                return (
                    <div className="p-4 space-y-4">
                        <div className="flex items-center gap-3"><button onClick={() => { setView('list'); setEditing(null); }} className="p-2 text-gray-400"><Icon name="arrowLeft" /></button><h2 className="text-xl font-bold">{editing ? 'Izmeni' : 'Novi'} korisnik</h2></div>
                        <input type="text" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="Ime i prezime" className="w-full p-4 border-2 border-gray-200 rounded-xl" />
                        <input type="text" value={form.pin} onChange={e => setForm({...form, pin: e.target.value.replace(/\D/g,'').slice(0,4)})} placeholder="PIN (4 cifre)" maxLength={4} className="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-2xl font-mono" />
                        <div className="grid grid-cols-3 gap-2">
                            {ROLES.map(r => <button key={r.id} onClick={() => setForm({...form, role: r.id})} className={`p-3 rounded-xl border-2 flex flex-col items-center gap-2 ${form.role === r.id ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`}><Icon name={r.icon} /><span className="text-sm">{r.name}</span></button>)}
                        </div>
                        {form.role === 'waiter' && <select value={form.locationId} onChange={e => setForm({...form, locationId: e.target.value})} className="w-full p-4 border-2 border-gray-200 rounded-xl"><option value="">-- Lokacija --</option>{LOCATIONS.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</select>}
                        <div className="flex gap-3"><button onClick={() => { setView('list'); setEditing(null); }} className="flex-1 py-4 border-2 border-gray-200 rounded-xl font-semibold">Otkaži</button><button onClick={handleSave} className="flex-1 py-4 bg-indigo-600 text-white rounded-xl font-semibold">Sačuvaj</button></div>
                    </div>
                );
            }

            return (
                <div className="p-4 space-y-4">
                    <div className="flex justify-between items-center"><div><h2 className="text-xl font-bold">Korisnici</h2><p className="text-gray-500 text-sm">{users.length} registrovanih</p></div><button onClick={() => { setForm({ name: '', pin: '', role: 'waiter', locationId: '' }); setView('form'); }} className="px-4 py-2 bg-indigo-600 text-white rounded-xl font-semibold flex items-center gap-2"><Icon name="userPlus" size={20} /> Dodaj</button></div>
                    <div className="space-y-3">
                        {users.map(u => {
                            const r = ROLES.find(x => x.id === u.role);
                            const l = LOCATIONS.find(x => x.id === u.locationId);
                            return (
                                <div key={u.id} className="bg-white rounded-xl p-4 border-2 border-gray-100">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="w-12 h-12 rounded-xl flex items-center justify-center bg-gray-100"><Icon name={r?.icon} /></div>
                                            <div><p className="font-semibold">{u.name}</p><p className="text-sm text-gray-500">{r?.name}{l && ` • ${l.name}`}</p></div>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <span className="px-3 py-1 bg-gray-100 rounded-lg font-mono font-bold text-gray-600">{u.pin}</span>
                                            <button onClick={() => { setEditing(u); setForm({name: u.name, pin: u.pin, role: u.role, locationId: u.locationId || ''}); setView('form'); }} className="p-2 text-gray-400"><Icon name="edit" size={20} /></button>
                                            <button onClick={() => setDelConfirm(u.id)} className="p-2 text-gray-400"><Icon name="trash" size={20} /></button>
                                        </div>
                                    </div>
                                    {delConfirm === u.id && (
                                        <div className="mt-3 p-3 bg-red-50 rounded-lg">
                                            <p className="text-red-800 text-sm mb-3">Obrisati {u.name}?</p>
                                            <div className="flex gap-2"><button onClick={() => { onDelete(u.id); setDelConfirm(null); }} className="flex-1 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold">Da</button><button onClick={() => setDelConfirm(null)} className="flex-1 py-2 bg-gray-200 rounded-lg text-sm font-semibold">Ne</button></div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // ==================== MAIN APP ====================
        function App() {
            const [users, setUsers] = useState(INITIAL_USERS);
            const [specs, setSpecs] = useState(INITIAL_SPECS);
            const [user, setUser] = useState(null);
            const [shift, setShift] = useState(null);
            const [view, setView] = useState('home');
            const [notif, setNotif] = useState(null);
            const [driverPickups, setDriverPickups] = useState([
                { id: 1, locationId: 'MP-PAL', status: 'pending' },
                { id: 2, locationId: 'MP-P47', status: 'pending' },
                { id: 3, locationId: 'MP-GIR', status: 'pending' },
            ]);

            const notify = (msg, type='success') => { setNotif({msg, type}); setTimeout(() => setNotif(null), 3000); };

            if (!user) return <LoginScreen onLogin={setUser} users={users} />;

            const titles = { 
                home: user.role === 'waiter' ? 'Početna' : user.role === 'driver' ? 'Preuzimanje' : 'Administracija', 
                users: 'Korisnici', 
                reports: 'Izveštaji' 
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    {notif && <Notification message={notif.msg} type={notif.type} onClose={() => setNotif(null)} />}
                    <Header user={user} onLogout={() => { setUser(null); setShift(null); setView('home'); }} title={titles[view]} onBack={view !== 'home' ? () => setView('home') : null} />
                    <div className="max-w-lg mx-auto">
                        {user.role === 'waiter' && view === 'home' && (
                            <WaiterHome 
                                user={user} 
                                currentShift={shift} 
                                onStartShift={() => { setShift({ startTime: new Date().toLocaleTimeString('sr-RS', {hour:'2-digit', minute:'2-digit'}) }); notify('Smena započeta!'); }} 
                                onEndShift={() => { setShift(null); notify('Pazar predat!'); }} 
                            />
                        )}
                        
                        {user.role === 'driver' && view === 'home' && (
                            <DriverHome 
                                pickups={driverPickups}
                                setPickups={setDriverPickups}
                                onHandover={() => { notify('Predato administratoru!'); setDriverPickups(driverPickups.map(p => ({...p, status: 'pending'}))); }}
                            />
                        )}
                        
                        {user.role === 'admin' && view === 'home' && (
                            <AdminHome 
                                onManageUsers={() => setView('users')} 
                                onReports={() => setView('reports')} 
                                specs={specs} 
                                setSpecs={setSpecs} 
                            />
                        )}
                        
                        {user.role === 'admin' && view === 'users' && (
                            <UserManagement 
                                users={users} 
                                onAdd={d => { setUsers([...users, {...d, id: Math.max(...users.map(u=>u.id))+1}]); notify('Korisnik dodat!'); }} 
                                onUpdate={(id,d) => { setUsers(users.map(u => u.id === id ? {...u,...d} : u)); notify('Sačuvano!'); }} 
                                onDelete={id => { setUsers(users.filter(u => u.id !== id)); notify('Obrisano!', 'error'); }} 
                            />
                        )}
                        
                        {user.role === 'admin' && view === 'reports' && (
                            <Reports specs={specs} />
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
