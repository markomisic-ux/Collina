<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Predaja Pazara - Sweet Collina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        // Ikone
        const Icon = ({name, size=24}) => {
            const icons = {
                wallet: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
                user: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                truck: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 18H3V7h10v11M14 9h4l4 4v4h-2M7 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM17 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>,
                shield: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
                logout: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>,
                clock: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>,
                mapPin: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
                chevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18l6-6-6-6"/></svg>,
                arrowLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>,
                check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 6L9 17l-5-5"/></svg>,
                x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>,
                bell: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
                creditCard: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>,
                banknote: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="12" cy="12" r="2"/></svg>,
                send: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>,
                package: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16.5 9.4L7.5 4.21M21 16V8l-9-5-9 5v8l9 5 9-5zM3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/></svg>,
                building: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18zM6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/></svg>,
                landmark: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 22h18M6 18V11M10 18V11M14 18V11M18 18V11M12 2l8 5H4l8-5z"/></svg>,
                users: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
                barChart: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>,
                calendar: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
                calculator: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M8 6h8M8 10h8M8 14h2M8 18h2M14 14h2M14 18h2"/></svg>,
                edit: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
                trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                alertCircle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h0"/></svg>,
            };
            return icons[name] || null;
        };

        // Podaci
        const LOCATIONS = [
            { id: 'MP-PAL', name: 'Palačinkarnica', short: 'PAL', company: 'Sweet Collina' },
            { id: 'MP-P47', name: 'Požeška 47', short: 'P47', company: 'Sweet Collina' },
            { id: 'MP-P96', name: 'Požeška 96', short: 'P96', company: 'Sweet Collina' },
            { id: 'MP-NBG', name: 'Novi Beograd', short: 'NBG', company: 'Sweet Collina' },
            { id: 'MP-DRAVSKA', name: 'Dravska', short: 'DRA', company: 'Sweet Collina' },
            { id: 'PRO-PEKARA', name: 'Pro Pekara', short: 'PEK', company: 'Sweet Collina' },
            { id: 'MP-GIR', name: 'Girosito', short: 'GIR', company: 'Prima Vidra' },
        ];

        const ROLES = [
            { id: 'waiter', name: 'Konobar', icon: 'user' },
            { id: 'driver', name: 'Vozač', icon: 'truck' },
            { id: 'admin', name: 'Administrator', icon: 'shield' },
        ];

        const INITIAL_USERS = [
            { id: 1, pin: '1234', name: 'Marko Marković', role: 'waiter', locationId: 'MP-PAL' },
            { id: 2, pin: '5678', name: 'Ana Anić', role: 'waiter', locationId: 'MP-P47' },
            { id: 3, pin: '1111', name: 'Nikola Nikolić', role: 'driver', locationId: null },
            { id: 4, pin: '2222', name: 'Jelena Jelić', role: 'admin', locationId: null },
        ];

        const INITIAL_SPECS = [
            { id: 1, locationId: 'MP-PAL', date: '10.01.2026.', status: 'pending', employee: 'M.M.', waiterData: { eBar: 85000, prenos: 12500, kartica: 28000, gotovina: 44500 }, inSafe: 44500 },
            { id: 2, locationId: 'MP-P47', date: '10.01.2026.', status: 'pending', employee: 'A.A.', waiterData: { eBar: 62000, prenos: 8000, kartica: 21500, gotovina: 32500 }, inSafe: 32500 },
            { id: 3, locationId: 'MP-GIR', date: '10.01.2026.', status: 'verified', employee: 'P.P.', waiterData: { eBar: 95000, prenos: 15000, kartica: 32000, gotovina: 48000 }, inSafe: 48000 },
            { id: 4, locationId: 'MP-NBG', date: '10.01.2026.', status: 'deposited', employee: 'I.I.', waiterData: { eBar: 78000, prenos: 10000, kartica: 25000, gotovina: 43000 }, inSafe: 0, depositedAmount: 43000, depositDate: '10.01.2026.' },
            { id: 5, locationId: 'MP-PAL', date: '09.01.2026.', status: 'deposited', employee: 'M.M.', waiterData: { eBar: 72000, prenos: 11000, kartica: 24000, gotovina: 37000 }, inSafe: 0, depositedAmount: 37000, depositDate: '09.01.2026.' },
            { id: 6, locationId: 'MP-P47', date: '09.01.2026.', status: 'deposited', employee: 'A.A.', waiterData: { eBar: 58000, prenos: 7500, kartica: 19000, gotovina: 31500 }, inSafe: 0, depositedAmount: 31500, depositDate: '09.01.2026.' },
            { id: 7, locationId: 'MP-P96', date: '09.01.2026.', status: 'deposited', employee: 'J.J.', waiterData: { eBar: 45000, prenos: 5000, kartica: 15000, gotovina: 25000 }, inSafe: 0, depositedAmount: 25000, depositDate: '09.01.2026.' },
            { id: 8, locationId: 'MP-GIR', date: '09.01.2026.', status: 'deposited', employee: 'P.P.', waiterData: { eBar: 88000, prenos: 14000, kartica: 30000, gotovina: 44000 }, inSafe: 0, depositedAmount: 44000, depositDate: '09.01.2026.' },
        ];

        const formatCurrency = (n) => new Intl.NumberFormat('sr-RS').format(n || 0) + ' RSD';
        const formatNumber = (n) => new Intl.NumberFormat('sr-RS').format(n || 0);

        // Notifikacija
        const Notification = ({ message, type, onClose }) => (
            <div className={`fixed top-4 right-4 left-4 z-50 p-4 rounded-lg border-2 shadow-lg flex items-center gap-3 ${type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : type === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-blue-50 border-blue-200 text-blue-800'}`}>
                <Icon name="bell" /><span className="font-medium flex-1">{message}</span><button onClick={onClose}><Icon name="x" /></button>
            </div>
        );

        // Header
        const Header = ({ user, onLogout, title, onBack }) => {
            const loc = LOCATIONS.find(l => l.id === user.locationId);
            return (
                <div className="bg-white border-b sticky top-0 z-40">
                    <div className="max-w-lg mx-auto px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            {onBack && <button onClick={onBack} className="p-2 -ml-2 text-gray-400"><Icon name="arrowLeft" /></button>}
                            <div><h1 className="font-bold text-gray-800">{title}</h1><p className="text-sm text-gray-500">{user.name}{loc && ` • ${loc.name}`}</p></div>
                        </div>
                        <button onClick={onLogout} className="p-2 text-gray-400 hover:text-red-500"><Icon name="logout" /></button>
                    </div>
                </div>
            );
        };

        // LOGIN
        const LoginScreen = ({ onLogin, users }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); const u = users.find(x => x.pin === pin); if (u) onLogin(u); else { setError('Pogrešna šifra'); setPin(''); } };
            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600"><Icon name="wallet" /></div>
                            <h1 className="text-2xl font-bold text-gray-800">Predaja Pazara</h1>
                            <p className="text-gray-500 mt-1">Unesite vašu šifru</p>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="flex justify-center gap-3 mb-6">
                                {[0,1,2,3].map(i => <div key={i} className={`w-14 h-14 rounded-xl border-2 flex items-center justify-center text-2xl font-bold ${pin.length > i ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`}>{pin.length > i ? '•' : ''}</div>)}
                            </div>
                            {error && <div className="text-red-500 text-center mb-4">{error}</div>}
                            <div className="grid grid-cols-3 gap-3 mb-6">
                                {[1,2,3,4,5,6,7,8,9,null,0,'del'].map((n,i) => <button key={i} type="button" onClick={() => n === 'del' ? setPin(p => p.slice(0,-1)) : n !== null && pin.length < 4 && setPin(p => p + n)} disabled={n === null} className={`h-14 rounded-xl text-xl font-semibold ${n === null ? 'invisible' : n === 'del' ? 'bg-gray-100' : 'bg-gray-50 active:scale-95'}`}>{n === 'del' ? '⌫' : n}</button>)}
                            </div>
                            <button type="submit" disabled={pin.length !== 4} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Prijava</button>
                        </form>
                    </div>
                </div>
            );
        };

        // KONOBAR - ZAVRŠETAK SMENE
        const WaiterEndShift = ({ user, onSubmit, onCancel }) => {
            const [step, setStep] = useState(1);
            const [data, setData] = useState({ eBar: '', prenos: '', kartica: '', gotovina: '' });
            const loc = LOCATIONS.find(l => l.id === user.locationId);
            const total = (parseInt(data.prenos) || 0) + (parseInt(data.kartica) || 0) + (parseInt(data.gotovina) || 0);

            return (
                <div className="p-4 space-y-4">
                    <div className="bg-indigo-50 rounded-xl p-4">
                        <p className="font-bold text-indigo-800">{loc?.name}</p>
                        <p className="text-sm text-indigo-600">Završetak smene - {new Date().toLocaleDateString('sr-RS')}</p>
                    </div>

                    {step === 1 && (
                        <>
                            <h2 className="text-xl font-bold">Unesite zaduženje</h2>
                            <div className="bg-white rounded-xl p-4 border-2">
                                <label className="text-sm font-medium text-gray-600 flex items-center gap-2 mb-2"><Icon name="calculator" size={18} /> E-Bar zaduženje</label>
                                <input type="number" value={data.eBar} onChange={(e) => setData({...data, eBar: e.target.value})} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl" />
                            </div>
                            <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                                <label className="text-sm font-medium text-blue-700 flex items-center gap-2 mb-2"><Icon name="send" size={18} /> Prenos na račun</label>
                                <input type="number" value={data.prenos} onChange={(e) => setData({...data, prenos: e.target.value})} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 border-blue-200 rounded-xl bg-white" />
                            </div>
                            <div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
                                <label className="text-sm font-medium text-purple-700 flex items-center gap-2 mb-2"><Icon name="creditCard" size={18} /> Kartica (Terminal)</label>
                                <input type="number" value={data.kartica} onChange={(e) => setData({...data, kartica: e.target.value})} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 border-purple-200 rounded-xl bg-white" />
                            </div>
                            <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                                <label className="text-sm font-medium text-green-700 flex items-center gap-2 mb-2"><Icon name="banknote" size={18} /> Gotovina</label>
                                <input type="number" value={data.gotovina} onChange={(e) => setData({...data, gotovina: e.target.value})} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 border-green-200 rounded-xl bg-white" />
                            </div>
                            <button onClick={() => setStep(2)} disabled={!data.eBar || !data.gotovina} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Nastavi</button>
                        </>
                    )}

                    {step === 2 && (
                        <>
                            <h2 className="text-xl font-bold">Potvrda</h2>
                            <div className="bg-gray-50 rounded-xl p-4 space-y-2">
                                <div className="flex justify-between py-2 border-b"><span>E-Bar:</span><span className="font-bold">{formatCurrency(data.eBar)}</span></div>
                                <div className="flex justify-between py-2 border-b text-blue-700"><span>Prenos:</span><span className="font-bold">{formatCurrency(data.prenos)}</span></div>
                                <div className="flex justify-between py-2 border-b text-purple-700"><span>Kartica:</span><span className="font-bold">{formatCurrency(data.kartica)}</span></div>
                                <div className="flex justify-between py-2 border-b text-green-700"><span>Gotovina:</span><span className="font-bold">{formatCurrency(data.gotovina)}</span></div>
                                <div className="flex justify-between py-2 bg-indigo-100 rounded px-3"><span className="font-semibold">UKUPNO:</span><span className="font-bold text-lg">{formatCurrency(total)}</span></div>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setStep(1)} className="flex-1 py-4 border-2 rounded-xl font-semibold">Nazad</button>
                                <button onClick={() => onSubmit({ eBar: parseInt(data.eBar)||0, prenos: parseInt(data.prenos)||0, kartica: parseInt(data.kartica)||0, gotovina: parseInt(data.gotovina)||0 })} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-semibold">✓ Predaj</button>
                            </div>
                        </>
                    )}
                    <button onClick={onCancel} className="w-full py-3 text-gray-500">Otkaži</button>
                </div>
            );
        };

        // KONOBAR HOME
        const WaiterHome = ({ user, currentShift, onStartShift, onEndShift }) => {
            const [showEndShift, setShowEndShift] = useState(false);
            const loc = LOCATIONS.find(l => l.id === user.locationId);

            if (showEndShift) return <WaiterEndShift user={user} onSubmit={(data) => { onEndShift(data); setShowEndShift(false); }} onCancel={() => setShowEndShift(false)} />;

            return (
                <div className="p-4 space-y-4">
                    <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white">
                        <div className="flex items-center gap-3 mb-4"><Icon name="mapPin" /><span className="opacity-80">{loc?.name}</span></div>
                        <h2 className="text-3xl font-bold">{currentShift ? 'Smena aktivna' : 'Nema smene'}</h2>
                        <p className="opacity-80">{currentShift ? `Započeto: ${currentShift.startTime}` : 'Započnite smenu'}</p>
                    </div>
                    {!currentShift ? (
                        <button onClick={onStartShift} className="w-full bg-green-500 text-white rounded-2xl p-6 flex items-center justify-between">
                            <div className="flex items-center gap-4"><div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center"><Icon name="clock" /></div><div className="text-left"><p className="font-bold text-lg">Započni smenu</p></div></div><Icon name="chevronRight" />
                        </button>
                    ) : (
                        <button onClick={() => setShowEndShift(true)} className="w-full bg-orange-500 text-white rounded-2xl p-6 flex items-center justify-between">
                            <div className="flex items-center gap-4"><div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center"><Icon name="logout" /></div><div className="text-left"><p className="font-bold text-lg">Završi smenu</p></div></div><Icon name="chevronRight" />
                        </button>
                    )}
                </div>
            );
        };

        // VOZAČ
        const DriverHome = ({ pickups, setPickups, onHandover }) => {
            const allPicked = pickups.every(p => p.status === 'picked');
            return (
                <div className="p-4 space-y-4">
                    <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 text-white">
                        <p className="text-3xl font-bold">{pickups.filter(p => p.status === 'picked').length} / {pickups.length}</p>
                        <p className="opacity-80">lokacija preuzeto</p>
                    </div>
                    {pickups.map(p => {
                        const loc = LOCATIONS.find(l => l.id === p.locationId);
                        return (
                            <div key={p.id} className={`rounded-xl p-4 border-2 ${p.status === 'picked' ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`}>
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${p.status === 'picked' ? 'bg-green-500 text-white' : 'bg-gray-100'}`}>
                                            {p.status === 'picked' ? <Icon name="check" size={20} /> : <Icon name="package" size={20} />}
                                        </div>
                                        <p className="font-semibold">{loc?.name}</p>
                                    </div>
                                    {p.status !== 'picked' && <button onClick={() => setPickups(pickups.map(x => x.id === p.id ? {...x, status: 'picked'} : x))} className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold">Preuzmi</button>}
                                </div>
                            </div>
                        );
                    })}
                    {allPicked && <button onClick={onHandover} className="w-full bg-green-500 text-white rounded-2xl p-6 flex items-center justify-between"><div className="flex items-center gap-4"><Icon name="building" /><span className="font-bold">Predaj administratoru</span></div><Icon name="chevronRight" /></button>}
                </div>
            );
        };

        // IZVEŠTAJI - DNEVNI
        const DailyOverview = ({ specs, selectedDate, onSelectDate }) => {
            const dates = [...new Set(specs.map(s => s.date))].sort().reverse();
            const daySpecs = specs.filter(s => s.date === selectedDate);
            const summary = { eBar: daySpecs.reduce((s, sp) => s + (sp.waiterData?.eBar || 0), 0), prenos: daySpecs.reduce((s, sp) => s + (sp.waiterData?.prenos || 0), 0), kartica: daySpecs.reduce((s, sp) => s + (sp.waiterData?.kartica || 0), 0), gotovina: daySpecs.reduce((s, sp) => s + (sp.waiterData?.gotovina || 0), 0) };

            return (
                <div className="space-y-4">
                    <div className="flex gap-2 overflow-x-auto pb-2">
                        {dates.map(date => <button key={date} onClick={() => onSelectDate(date)} className={`px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap ${selectedDate === date ? 'bg-indigo-600 text-white' : 'bg-gray-100'}`}>{date}</button>)}
                    </div>
                    <div className="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-4 text-white">
                        <p className="font-semibold mb-3">{selectedDate} - Sumarno</p>
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white/20 rounded-xl p-3"><p className="text-xs opacity-80">E-Bar</p><p className="text-lg font-bold">{formatNumber(summary.eBar)}</p></div>
                            <div className="bg-white/20 rounded-xl p-3"><p className="text-xs opacity-80">Prenos</p><p className="text-lg font-bold">{formatNumber(summary.prenos)}</p></div>
                            <div className="bg-white/20 rounded-xl p-3"><p className="text-xs opacity-80">Kartica</p><p className="text-lg font-bold">{formatNumber(summary.kartica)}</p></div>
                            <div className="bg-white/20 rounded-xl p-3"><p className="text-xs opacity-80">Gotovina</p><p className="text-lg font-bold">{formatNumber(summary.gotovina)}</p></div>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl border-2 overflow-hidden">
                        <div className="bg-gray-50 p-3 border-b font-bold">Po radnjama</div>
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50"><tr><th className="text-left p-3">Radnja</th><th className="text-right p-3">E-Bar</th><th className="text-right p-3">Prenos</th><th className="text-right p-3">Kartica</th><th className="text-right p-3 text-green-700">Gotovina</th></tr></thead>
                            <tbody>
                                {daySpecs.map(sp => {
                                    const loc = LOCATIONS.find(l => l.id === sp.locationId);
                                    return <tr key={sp.id} className="border-t"><td className="p-3 font-semibold">{loc?.short}<br/><span className="text-xs text-gray-500">{sp.employee}</span></td><td className="text-right p-3">{formatNumber(sp.waiterData?.eBar)}</td><td className="text-right p-3 text-blue-600">{formatNumber(sp.waiterData?.prenos)}</td><td className="text-right p-3 text-purple-600">{formatNumber(sp.waiterData?.kartica)}</td><td className="text-right p-3 font-bold text-green-700">{formatNumber(sp.waiterData?.gotovina)}</td></tr>;
                                })}
                            </tbody>
                            <tfoot className="bg-indigo-50 font-bold"><tr><td className="p-3">UKUPNO</td><td className="text-right p-3">{formatNumber(summary.eBar)}</td><td className="text-right p-3 text-blue-600">{formatNumber(summary.prenos)}</td><td className="text-right p-3 text-purple-600">{formatNumber(summary.kartica)}</td><td className="text-right p-3 text-green-700">{formatNumber(summary.gotovina)}</td></tr></tfoot>
                        </table>
                    </div>
                </div>
            );
        };

        // IZVEŠTAJI - MESEČNI
        const MonthlyReport = ({ specs }) => {
            const dates = [...new Set(specs.map(s => s.date))].sort();
            const dailySummaries = dates.map(date => {
                const daySpecs = specs.filter(s => s.date === date);
                return { date, eBar: daySpecs.reduce((s, sp) => s + (sp.waiterData?.eBar || 0), 0), prenos: daySpecs.reduce((s, sp) => s + (sp.waiterData?.prenos || 0), 0), kartica: daySpecs.reduce((s, sp) => s + (sp.waiterData?.kartica || 0), 0), gotovina: daySpecs.reduce((s, sp) => s + (sp.waiterData?.gotovina || 0), 0), locations: daySpecs.length };
            });
            const monthTotal = { eBar: dailySummaries.reduce((s, d) => s + d.eBar, 0), prenos: dailySummaries.reduce((s, d) => s + d.prenos, 0), kartica: dailySummaries.reduce((s, d) => s + d.kartica, 0), gotovina: dailySummaries.reduce((s, d) => s + d.gotovina, 0) };
            const byLocation = LOCATIONS.map(loc => {
                const locSpecs = specs.filter(s => s.locationId === loc.id);
                return { ...loc, eBar: locSpecs.reduce((s, sp) => s + (sp.waiterData?.eBar || 0), 0), prenos: locSpecs.reduce((s, sp) => s + (sp.waiterData?.prenos || 0), 0), kartica: locSpecs.reduce((s, sp) => s + (sp.waiterData?.kartica || 0), 0), gotovina: locSpecs.reduce((s, sp) => s + (sp.waiterData?.gotovina || 0), 0), count: locSpecs.length };
            }).filter(l => l.count > 0);

            return (
                <div className="space-y-4">
                    <div className="bg-gradient-to-r from-purple-500 to-pink-600 rounded-2xl p-6 text-white">
                        <p className="font-bold text-lg mb-4">Januar 2026 - Sumarno</p>
                        <div className="grid grid-cols-2 gap-4">
                            <div><p className="opacity-80 text-sm">E-Bar</p><p className="text-2xl font-bold">{formatNumber(monthTotal.eBar)}</p></div>
                            <div><p className="opacity-80 text-sm">Gotovina</p><p className="text-2xl font-bold">{formatNumber(monthTotal.gotovina)}</p></div>
                            <div><p className="opacity-80 text-sm">Prenos</p><p className="text-xl font-bold">{formatNumber(monthTotal.prenos)}</p></div>
                            <div><p className="opacity-80 text-sm">Kartica</p><p className="text-xl font-bold">{formatNumber(monthTotal.kartica)}</p></div>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl border-2 overflow-hidden">
                        <div className="bg-gray-50 p-3 border-b font-bold">Mesečno po radnjama</div>
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50"><tr><th className="text-left p-3">Radnja</th><th className="text-right p-3">E-Bar</th><th className="text-right p-3">Prenos</th><th className="text-right p-3">Kartica</th><th className="text-right p-3 text-green-700">Gotovina</th></tr></thead>
                            <tbody>{byLocation.map(loc => <tr key={loc.id} className="border-t"><td className="p-3 font-semibold">{loc.name}<br/><span className="text-xs text-gray-500">{loc.count} dana</span></td><td className="text-right p-3">{formatNumber(loc.eBar)}</td><td className="text-right p-3 text-blue-600">{formatNumber(loc.prenos)}</td><td className="text-right p-3 text-purple-600">{formatNumber(loc.kartica)}</td><td className="text-right p-3 font-bold text-green-700">{formatNumber(loc.gotovina)}</td></tr>)}</tbody>
                            <tfoot className="bg-purple-50 font-bold"><tr><td className="p-3">UKUPNO</td><td className="text-right p-3">{formatNumber(monthTotal.eBar)}</td><td className="text-right p-3 text-blue-600">{formatNumber(monthTotal.prenos)}</td><td className="text-right p-3 text-purple-600">{formatNumber(monthTotal.kartica)}</td><td className="text-right p-3 text-green-700">{formatNumber(monthTotal.gotovina)}</td></tr></tfoot>
                        </table>
                    </div>
                    <div className="bg-white rounded-xl border-2 overflow-hidden">
                        <div className="bg-gray-50 p-3 border-b font-bold">Po danima</div>
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50"><tr><th className="text-left p-3">Datum</th><th className="text-center p-3">Radnje</th><th className="text-right p-3">E-Bar</th><th className="text-right p-3">Prenos</th><th className="text-right p-3">Kartica</th><th className="text-right p-3 text-green-700">Gotovina</th></tr></thead>
                            <tbody>{dailySummaries.map(day => <tr key={day.date} className="border-t"><td className="p-3 font-semibold">{day.date}</td><td className="text-center p-3">{day.locations}</td><td className="text-right p-3">{formatNumber(day.eBar)}</td><td className="text-right p-3 text-blue-600">{formatNumber(day.prenos)}</td><td className="text-right p-3 text-purple-600">{formatNumber(day.kartica)}</td><td className="text-right p-3 font-bold text-green-700">{formatNumber(day.gotovina)}</td></tr>)}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // IZVEŠTAJI
        const Reports = ({ specs }) => {
            const [tab, setTab] = useState('daily');
            const [selectedDate, setSelectedDate] = useState('10.01.2026.');
            return (
                <div className="p-4 space-y-4">
                    <div className="flex gap-2 bg-gray-100 p-1 rounded-xl">
                        <button onClick={() => setTab('daily')} className={`flex-1 py-2 rounded-lg text-sm font-semibold ${tab === 'daily' ? 'bg-white shadow text-indigo-600' : ''}`}>Dnevni</button>
                        <button onClick={() => setTab('monthly')} className={`flex-1 py-2 rounded-lg text-sm font-semibold ${tab === 'monthly' ? 'bg-white shadow text-indigo-600' : ''}`}>Mesečni</button>
                    </div>
                    {tab === 'daily' && <DailyOverview specs={specs} selectedDate={selectedDate} onSelectDate={setSelectedDate} />}
                    {tab === 'monthly' && <MonthlyReport specs={specs} />}
                </div>
            );
        };

        // ADMIN HOME
        const AdminHome = ({ onManageUsers, onReports, specs, setSpecs }) => {
            const [tab, setTab] = useState('pending');
            const [verifyingId, setVerifyingId] = useState(null);
            const [adminGotovina, setAdminGotovina] = useState(0);

            const pending = specs.filter(s => s.status === 'pending');
            const verified = specs.filter(s => s.status === 'verified');
            const deposited = specs.filter(s => s.status === 'deposited');
            const totalInSafe = verified.reduce((sum, s) => sum + (s.inSafe || 0), 0);

            const handleVerify = (id) => {
                setSpecs(specs.map(s => s.id === id ? { ...s, status: 'verified', inSafe: adminGotovina } : s));
                setVerifyingId(null);
            };

            const handleDeposit = (id) => {
                const today = new Date().toLocaleDateString('sr-RS');
                setSpecs(specs.map(s => s.id === id ? { ...s, status: 'deposited', depositedAmount: s.inSafe, depositDate: today, inSafe: 0 } : s));
            };

            if (verifyingId) {
                const sp = specs.find(s => s.id === verifyingId);
                const loc = LOCATIONS.find(l => l.id === sp?.locationId);
                return (
                    <div className="p-4 space-y-4">
                        <div className="bg-indigo-50 rounded-xl p-4">
                            <p className="font-bold text-indigo-800">{loc?.name}</p>
                            <p className="text-sm text-indigo-600">{sp?.date} • {sp?.employee}</p>
                        </div>
                        <div className="bg-gray-50 rounded-xl p-4 space-y-2">
                            <div className="flex justify-between"><span>E-Bar:</span><span className="font-bold">{formatCurrency(sp?.waiterData?.eBar)}</span></div>
                            <div className="flex justify-between text-blue-700"><span>Prenos:</span><span className="font-bold">{formatCurrency(sp?.waiterData?.prenos)}</span></div>
                            <div className="flex justify-between text-purple-700"><span>Kartica:</span><span className="font-bold">{formatCurrency(sp?.waiterData?.kartica)}</span></div>
                            <div className="flex justify-between text-green-700 pt-2 border-t"><span className="font-semibold">Gotovina (prijavljeno):</span><span className="font-bold text-lg">{formatCurrency(sp?.waiterData?.gotovina)}</span></div>
                        </div>
                        <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                            <label className="text-sm font-medium text-green-700 mb-2 block">Vaše brojanje gotovine:</label>
                            <input type="number" value={adminGotovina} onChange={(e) => setAdminGotovina(parseInt(e.target.value) || 0)} className="w-full p-4 text-2xl font-bold text-center border-2 border-green-200 rounded-xl" />
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => setVerifyingId(null)} className="flex-1 py-4 border-2 rounded-xl font-semibold">Otkaži</button>
                            <button onClick={() => handleVerify(verifyingId)} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-semibold">✓ Potvrdi</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-4 space-y-4">
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={onManageUsers} className="bg-gradient-to-br from-purple-500 to-indigo-600 text-white rounded-2xl p-4"><Icon name="users" /><p className="font-semibold mt-2">Korisnici</p></button>
                        <button onClick={onReports} className="bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-2xl p-4"><Icon name="barChart" /><p className="font-semibold mt-2">Izveštaji</p></button>
                    </div>
                    <div className="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 text-white flex justify-between items-center">
                        <div><p className="opacity-80 text-sm">U sefu</p><p className="text-2xl font-bold">{formatCurrency(totalInSafe)}</p></div>
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                        <button onClick={() => setTab('pending')} className={`rounded-xl p-3 ${tab === 'pending' ? 'bg-orange-100 border-2 border-orange-300' : 'bg-gray-50'}`}><p className="text-2xl font-bold text-orange-600">{pending.length}</p><p className="text-xs">Za proveru</p></button>
                        <button onClick={() => setTab('verified')} className={`rounded-xl p-3 ${tab === 'verified' ? 'bg-blue-100 border-2 border-blue-300' : 'bg-gray-50'}`}><p className="text-2xl font-bold text-blue-600">{verified.length}</p><p className="text-xs">U sefu</p></button>
                        <button onClick={() => setTab('deposited')} className={`rounded-xl p-3 ${tab === 'deposited' ? 'bg-green-100 border-2 border-green-300' : 'bg-gray-50'}`}><p className="text-2xl font-bold text-green-600">{deposited.length}</p><p className="text-xs">Uplaćeno</p></button>
                    </div>

                    {tab === 'pending' && pending.map(sp => {
                        const loc = LOCATIONS.find(l => l.id === sp.locationId);
                        return (
                            <div key={sp.id} className="bg-white rounded-xl p-4 border-2 border-orange-200">
                                <div className="flex justify-between mb-3"><div><p className="font-semibold">{loc?.name}</p><p className="text-sm text-gray-500">{sp.date} • {sp.employee}</p></div><p className="font-bold text-lg text-green-700">{formatCurrency(sp.waiterData?.gotovina)}</p></div>
                                <div className="grid grid-cols-3 gap-2 text-xs mb-3">
                                    <div className="bg-gray-50 rounded p-2 text-center"><p className="text-gray-500">E-Bar</p><p className="font-bold">{formatNumber(sp.waiterData?.eBar)}</p></div>
                                    <div className="bg-blue-50 rounded p-2 text-center"><p className="text-blue-600">Prenos</p><p className="font-bold text-blue-700">{formatNumber(sp.waiterData?.prenos)}</p></div>
                                    <div className="bg-purple-50 rounded p-2 text-center"><p className="text-purple-600">Kartica</p><p className="font-bold text-purple-700">{formatNumber(sp.waiterData?.kartica)}</p></div>
                                </div>
                                <button onClick={() => { setVerifyingId(sp.id); setAdminGotovina(sp.waiterData?.gotovina || 0); }} className="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold">Proveri gotovinu</button>
                            </div>
                        );
                    })}

                    {tab === 'verified' && verified.map(sp => {
                        const loc = LOCATIONS.find(l => l.id === sp.locationId);
                        return (
                            <div key={sp.id} className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                                <div className="flex justify-between items-center mb-3"><div><p className="font-semibold">{loc?.name}</p><p className="text-sm text-gray-500">{sp.date}</p></div><p className="font-bold text-xl text-blue-700">{formatCurrency(sp.inSafe)}</p></div>
                                <button onClick={() => handleDeposit(sp.id)} className="w-full py-3 bg-green-500 text-white rounded-lg font-semibold">Označi kao uplaćeno</button>
                            </div>
                        );
                    })}

                    {tab === 'deposited' && deposited.map(sp => {
                        const loc = LOCATIONS.find(l => l.id === sp.locationId);
                        return (
                            <div key={sp.id} className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                                <div className="flex justify-between items-center"><div><p className="font-semibold">{loc?.name}</p><p className="text-sm text-green-600">{sp.depositDate}</p></div><p className="font-bold text-green-700">{formatCurrency(sp.depositedAmount)}</p></div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // USER MANAGEMENT
        const UserManagement = ({ users, onAdd, onUpdate, onDelete }) => {
            const [view, setView] = useState('list');
            const [editing, setEditing] = useState(null);
            const [form, setForm] = useState({ name: '', pin: '', role: 'waiter', locationId: '' });

            if (view === 'form') {
                return (
                    <div className="p-4 space-y-4">
                        <h2 className="text-xl font-bold">{editing ? 'Izmeni' : 'Novi'} korisnik</h2>
                        <input type="text" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="Ime" className="w-full p-4 border-2 rounded-xl" />
                        <input type="text" value={form.pin} onChange={e => setForm({...form, pin: e.target.value.replace(/\D/g,'').slice(0,4)})} placeholder="PIN" maxLength={4} className="w-full p-4 border-2 rounded-xl text-center text-2xl font-mono" />
                        <div className="grid grid-cols-3 gap-2">
                            {ROLES.map(r => <button key={r.id} onClick={() => setForm({...form, role: r.id})} className={`p-3 rounded-xl border-2 ${form.role === r.id ? 'border-indigo-500 bg-indigo-50' : ''}`}><Icon name={r.icon} /><p className="text-sm mt-1">{r.name}</p></button>)}
                        </div>
                        {form.role === 'waiter' && <select value={form.locationId} onChange={e => setForm({...form, locationId: e.target.value})} className="w-full p-4 border-2 rounded-xl"><option value="">-- Lokacija --</option>{LOCATIONS.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</select>}
                        <div className="flex gap-3"><button onClick={() => setView('list')} className="flex-1 py-4 border-2 rounded-xl font-semibold">Otkaži</button><button onClick={() => { if (editing) onUpdate(editing.id, form); else onAdd(form); setView('list'); setForm({ name: '', pin: '', role: 'waiter', locationId: '' }); setEditing(null); }} className="flex-1 py-4 bg-indigo-600 text-white rounded-xl font-semibold">Sačuvaj</button></div>
                    </div>
                );
            }

            return (
                <div className="p-4 space-y-4">
                    <div className="flex justify-between items-center"><h2 className="text-xl font-bold">Korisnici</h2><button onClick={() => setView('form')} className="px-4 py-2 bg-indigo-600 text-white rounded-xl font-semibold">+ Dodaj</button></div>
                    {users.map(u => {
                        const r = ROLES.find(x => x.id === u.role);
                        const l = LOCATIONS.find(x => x.id === u.locationId);
                        return (
                            <div key={u.id} className="bg-white rounded-xl p-4 border-2 flex justify-between items-center">
                                <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center"><Icon name={r?.icon} size={20} /></div><div><p className="font-semibold">{u.name}</p><p className="text-sm text-gray-500">{r?.name}{l && ` • ${l.short}`}</p></div></div>
                                <div className="flex items-center gap-2"><span className="px-2 py-1 bg-gray-100 rounded font-mono text-sm">{u.pin}</span><button onClick={() => { setEditing(u); setForm({...u, locationId: u.locationId || ''}); setView('form'); }} className="p-2 text-gray-400"><Icon name="edit" size={18} /></button><button onClick={() => onDelete(u.id)} className="p-2 text-gray-400"><Icon name="trash" size={18} /></button></div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // MAIN APP
        function App() {
            const [users, setUsers] = useState(INITIAL_USERS);
            const [specs, setSpecs] = useState(INITIAL_SPECS);
            const [user, setUser] = useState(null);
            const [shift, setShift] = useState(null);
            const [view, setView] = useState('home');
            const [notif, setNotif] = useState(null);
            const [driverPickups, setDriverPickups] = useState([{ id: 1, locationId: 'MP-PAL', status: 'pending' }, { id: 2, locationId: 'MP-P47', status: 'pending' }, { id: 3, locationId: 'MP-GIR', status: 'pending' }]);

            const notify = (msg, type='success') => { setNotif({msg, type}); setTimeout(() => setNotif(null), 3000); };

            const handleWaiterEndShift = (data) => {
                const newSpec = { id: specs.length + 1, locationId: user.locationId, date: new Date().toLocaleDateString('sr-RS'), status: 'pending', employee: user.name.split(' ').map(n => n[0]).join('.') + '.', waiterData: data, inSafe: data.gotovina };
                setSpecs([newSpec, ...specs]);
                setShift(null);
                notify('Pazar predat!');
            };

            if (!user) return <LoginScreen onLogin={setUser} users={users} />;

            const titles = { home: user.role === 'waiter' ? 'Početna' : user.role === 'driver' ? 'Preuzimanje' : 'Administracija', users: 'Korisnici', reports: 'Izveštaji' };

            return (
                <div className="min-h-screen bg-gray-100">
                    {notif && <Notification message={notif.msg} type={notif.type} onClose={() => setNotif(null)} />}
                    <Header user={user} onLogout={() => { setUser(null); setShift(null); setView('home'); }} title={titles[view]} onBack={view !== 'home' ? () => setView('home') : null} />
                    <div className="max-w-lg mx-auto pb-8">
                        {user.role === 'waiter' && view === 'home' && <WaiterHome user={user} currentShift={shift} onStartShift={() => { setShift({ startTime: new Date().toLocaleTimeString('sr-RS', {hour:'2-digit', minute:'2-digit'}) }); notify('Smena započeta!'); }} onEndShift={handleWaiterEndShift} />}
                        {user.role === 'driver' && view === 'home' && <DriverHome pickups={driverPickups} setPickups={setDriverPickups} onHandover={() => { notify('Predato!'); setDriverPickups(driverPickups.map(p => ({...p, status: 'pending'}))); }} />}
                        {user.role === 'admin' && view === 'home' && <AdminHome onManageUsers={() => setView('users')} onReports={() => setView('reports')} specs={specs} setSpecs={setSpecs} />}
                        {user.role === 'admin' && view === 'users' && <UserManagement users={users} onAdd={d => { setUsers([...users, {...d, id: Math.max(...users.map(u=>u.id))+1}]); notify('Dodato!'); }} onUpdate={(id,d) => { setUsers(users.map(u => u.id === id ? {...u,...d} : u)); notify('Sačuvano!'); }} onDelete={id => { setUsers(users.filter(u => u.id !== id)); notify('Obrisano!', 'error'); }} />}
                        {user.role === 'admin' && view === 'reports' && <Reports specs={specs} />}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
